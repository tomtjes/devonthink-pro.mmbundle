#!/bin/bash

tmpfile="$TMPDIR/D6D5F966-41E9-488F-A4EA-76E37744A558.eml"
cat > "${tmpfile}"

# Tricky substitution to make it work for " and \ in the AppleScript below.
name=${MM_SUBJECT//\\/\\\\}
name=${name//\"/\\\"}
url="message://%3c${MM_MESSAGE_ID}%3e"

osascript <<END

try
	tell application id "DNtp"
		set theRecord to import "${tmpfile}" from "MailMate" name "${name}"
		set modification date of theRecord to creation date of theRecord
		set the URL of theRecord to "${url}" # Allows it to be opened in MailMate using ⌃⌘O
	        display notification "Added message \"${name}\" to DEVONthink" with title "MailMate"
	end tell
on error errMsg number eNum
	tell application "System Events"
		activate
		display alert "DEVONThink: " & eNum message errMsg
	end tell
end try

END

unlink "${tmpfile}"
